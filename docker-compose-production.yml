services:
  php: &php
    image: endlezz/artwork:${ARTWORK_VERSION:-latest}
    pull_policy: always
    depends_on:
      - mysql
    env_file:
      - .env
    networks:
      - artwork
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - "artwork:/var/www/html"
  php-queue-worker:
    <<: *php
    command: 'php artisan schedule:work'
  php-scheduler:
    <<: *php
    command: 'yacron -c schedule.yaml'
  php-updater:
    <<: *php
    command: 'sh dockerfiles/php/update.sh'
    volumes:
      - '.env:/var/www/html/.env'
  nginx:
    build:
      context: .
      dockerfile: dockerfiles/nginx/release.Dockerfile
    ports:
      - '${FORWARD_ARTWORK_PORT:-80}:80'
      - '${FORWARD_ARTWORK_SSL_PORT:-443}:443'
    depends_on:
      - php
    volumes:
      - "artwork:/var/www/html/:cached"
    networks:
      - artwork
  mysql:
    image: 'mysql/mysql-server:8.0'
    ports:
      - '${FORWARD_DB_PORT:-3306}:3306'
    environment:
      MYSQL_ROOT_PASSWORD: '${DB_PASSWORD}'
      MYSQL_ROOT_HOST: '%'
      MYSQL_DATABASE: '${DB_DATABASE}'
      MYSQL_USER: '${DB_USERNAME}'
      MYSQL_PASSWORD: '${DB_PASSWORD}'
      MYSQL_ALLOW_EMPTY_PASSWORD: false
    volumes:
      - 'artwork-mysql:/var/lib/mysql'
    networks:
      - artwork
    healthcheck:
      test:
        - CMD
        - mysqladmin
        - ping
        - '-p${DB_PASSWORD}'
      retries: 3
      timeout: 5s
  soketi:
    image: 'quay.io/soketi/soketi:latest-16-alpine'
    environment:
      SOKETI_DEBUG: '${SOKETI_DEBUG:-1}'
      SOKETI_METRICS_SERVER_PORT: '9601'
      SOKETI_DEFAULT_APP_ID: '${PUSHER_APP_ID}'
      SOKETI_DEFAULT_APP_KEY: '${PUSHER_APP_KEY}'
      SOKETI_DEFAULT_APP_SECRET: '${PUSHER_APP_SECRET}'
    ports:
      - '${PUSHER_PORT:-6001}:6001'
      - '${PUSHER_METRICS_PORT:-9601}:9601'
    networks:
      - artwork
  redis:
    image: 'redis:alpine'
    ports:
      - '${FORWARD_REDIS_PORT:-6379}:6379'
    volumes:
      - 'artwork-redis:/data'
    networks:
      - artwork
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      retries: 3
      timeout: 5s
  meilisearch:
    image: 'getmeili/meilisearch:latest'
    ports:
      - '${FORWARD_MEILISEARCH_PORT:-7700}:7700'
    volumes:
      - 'artwork-meilisearch:/meili_data_v2'
    networks:
      - artwork
    healthcheck:
      test:
        - CMD
        - wget
        - '--no-verbose'
        - '--spider'
        - 'http://localhost:7700/health'
      retries: 3
      timeout: 5s
networks:
  artwork:
    driver: bridge
volumes:
  artwork-mysql:
    driver: local
  artwork-meilisearch:
    driver: local
  artwork-redis:
    driver: local
  artwork:

